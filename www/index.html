<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="apple-touch-icon" sizes="57x57" href="assets/img/favicons/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="assets/img/favicons/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="assets/img/favicons/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="assets/img/favicons/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="assets/img/favicons/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="assets/img/favicons/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="assets/img/favicons/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="assets/img/favicons/apple-touch-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicons/apple-touch-icon-180x180.png">
        <link rel="icon" type="image/png" href="assets/img/favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="assets/img/favicons/android-chrome-192x192.png" sizes="192x192">
        <link rel="icon" type="image/png" href="assets/img/favicons/favicon-96x96.png" sizes="96x96">
        <link rel="icon" type="image/png" href="assets/img/favicons/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="assets/img/favicons/manifest.json">
        <!--
        <meta name="msapplication-TileColor" content="#2b5797">
        <meta name="msapplication-TileImage" content="assets/img/favicons/mstile-144x144.png">
        <meta name="theme-color" content="#ffffff">
    -->
        <title>NOX</title>

        <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" type="text/css">
        <link rel="stylesheet" href="bower_components/framework7/dist/css/framework7.ios.min.css" type="text/css">
        <link rel="stylesheet" href="bower_components/swipebox/src/css/swipebox.css" type="text/css">
        <link rel="stylesheet" href="bower_components/owl-carousel/owl-carousel/owl.carousel.css" type="text/css">
        <link rel="stylesheet" href="bower_components/owl-carousel/owl-carousel/owl.theme.css" type="text/css">

        <link rel="stylesheet" href="assets/css/app.css" type="text/css">
        <!--<link rel="stylesheet" href="assets/themes//style.css" id="theme-style">-->

        <style>
            .list-block {
                margin: 5px 0;
            }

            .buttonTabProduct {
                min-height: 32px;
                line-height: 30px;
            }

            /* CSS TAB BAR "COMPRAR" ---------------------------------------- */
            #tabbar-buy div[class*="col-"] {
                text-align: center;
                color: #FFF;
                padding: 5px 0px;
                font-size: 11px;
            }
            #tabbar-buy div[class*="col-"] strong {
                font-size: 22px;
                 display:block; 
                 clear:both
            }
            
            /* CSS FILTRO --------------------------------------------------- */
            #page-filter .swiper-wrapper {
                margin: 5px;
            }
            #page-filter .swiper-slide {
                color:#000;
                background: #FFF;
                box-sizing: border-box;
                border: 1px solid #ccc;
            }
            #page-filter .swiper-slide label {
                text-align:center;
                display:block;
                padding-top: 20px;
                padding-bottom: 100%;
                font-size:16px;
            }
            #page-filter .swiper-slide label div {
                text-align:center;
                width: 100%;
            }
            #page-filter .swiper-slide label div.item-inner {
                padding-top: 35px;
            }
            #page-filter .swiper-container {
                height: 120px;
                margin: 5px;
            }
            #page-filter .swiper-slide label.label-radio input[type=radio]:checked~.item-inner {
                background-size: 32px;
                background-position: center top;
            }
            #page-filter .swiper-slide label.label-radio input[type=radio]~.item-inner {
                padding-right: 0px;
            }
            
            
        </style>

    </head>
    <body class="">

        <div class="statusbar-overlay"></div>
        <div class="panel-overlay"></div>

        <!-- Left panel -->
        <div class="panel panel-left panel-reveal">
            <div class="line"></div>

            <div class="logo-box mt-10">
                <strong>Saldo Atual</strong>
                <div>R$ 0,00</div>
            </div>

            <div class="list-block mt-15">
                <div class="list-group">
                    <nav>
                        <ul>
                            <li class="divider">
                                Menu
                            </li>
                            <!--
                            <li>
                                <a href="profile.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-user"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Perfil</div>
                                    </div>
                                </a>
                            </li>
                            -->
                            <li>
                                <a href="main.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-tags"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Promoções</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="establishment.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-home"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Estabelecimentos</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="shopping.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-check"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Compras realizadas</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="cash-out.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-money"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Solicitar saque</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="invite-friend.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-users"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Convidar amigos</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="filter.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-filter"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Filtrar</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="change-password.html" class="item-link close-panel item-content">
                                    <div class="item-media">
                                        <i class="fa fa-key"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Alterar senha</div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="item-link close-panel item-content" onclick="logout()">
                                    <div class="item-media">
                                        <i class="fa fa-close"></i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">Sair</div>
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

        </div>

        <!-- Right panel -->
        <div class="panel panel-right panel-reveal"></div>

        <!-- Views -->
        <div class="views">
            <div class="view view-main">
                <div class="navbar"></div>
                <div class="pages navbar-fixed toolbar-fixed "></div>
            </div>
        </div>

        <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="bower_components/swipebox/src/js/jquery.swipebox.min.js"></script>
        <script type="text/javascript" src="bower_components/framework7/dist/js/framework7.min.js"></script>
        <script type="text/javascript" src="bower_components/jquery-validation/dist/jquery.validate.min.js"></script>
        <script type="text/javascript" src="bower_components/Tweetie/tweetie.min.js"></script>
        <script type="text/javascript" src="bower_components/chartjs/Chart.js"></script>
        <script type="text/javascript" src="bower_components/scrollAnimate/jquery.scrollAnimate.js"></script>
        <script src="bower_components/owl-carousel/owl-carousel/owl.carousel.min.js"></script>

        <script type="text/javascript" src="assets/js/jflickrfeed.min.js"></script>
        <script type="text/javascript" src="assets/js/min/app.js"></script>
        <script type="text/javascript" src="assets/js/animations.js"></script>

        <!-- Complementares -->
        <script type="text/javascript" src="assets/js/jquery-block/jquery.blockUI.js"></script>
        <script type="text/javascript" src="assets/js/masked-input/jquery.maskedinput.min.js"></script>
        <script type="text/javascript" src="assets/js/masked-input/jquery.maskMoney.min.js"></script>
        <script type="text/javascript" src="assets/js/appExt.js"></script>
        <script type="text/javascript" src="assets/js/global.js"></script>
        
        
        <!-- iugu local -->
        <script type="text/javascript" src="assets/js/iugu.js"></script>
        <!-- iugu remoto -->
        <!-- <script type="text/javascript" src="https://js.iugu.com/v2"></script> -->
        <script type="text/javascript" src="assets/js/formatter.js"></script>
        
        <script>
            
            $(".btnBack").click(function(){
                var backButtonEvent = document.createEvent('Events');
                backButtonEvent.initEvent('backbutton', false, false);
                document.dispatchEvent(backButtonEvent);
            });
            
            // mascara de CPF
            // $("input[name='cpf_cnpj']").mask("999.999.999-99").attr('placeholder', 'CPF');
            
            
            // -----------------------------------------------------------------
            // index carrega a pagina principal de promocoes ou tela de login
            (validateLogin()) ? mainView.router.loadPage('main.html') : mainView.router.loadPage('login.html');

            // -----------------------------------------------------------------
            // login
            myApp.onPageInit('login', function (page) {
                $$('#login-button').on('click', function () {
                    validateLogin(myApp.formToJSON('#login-form'));
                });
            });
            
            
            // -----------------------------------------------------------------
            // registration
            myApp.onPageInit('registration', function (page) {

                // envia form de cadastro de usuario
                $$('#loginCreate-button').on('click', function () {
                    ajaxApi('login-create', myApp.formToJSON('#loginCreate-form'), callbackLoginCreate);
                });

                // callback login create
                var callbackLoginCreate = function(a) {
                    myApp.alert('','Usuário cadastrado!');
                    mainView.router.loadPage('index.html');
                };
            });
            

            // -----------------------------------------------------------------
            // promocoes
            securePage('main', function (page) {
                var templateMain = new Template('templateMain');
                $.extend(page.query, {user_auth_key: getUserData().auth_key});
                templateMain.compileAjax('promocao', page.query, function (a) {
                    if (!a.estabelecimentos.length) {
                        myApp.alert('Nenhum estabelecimento encontrado para o filtro selecionado...', 'Opss', function(){ 
                            mainView.router.loadPage('filter.html'); 
                        });
                    }
                });
            });
            
            
            // -----------------------------------------------------------------
            // pesquisa
            securePage('search', function (page) {
                var templateSearch = new Template('templateSearch');

                // realiza pesquisa
                $$('#btn-pesquisa').on('click', function () {
                    var dataPesquisa = $('input#campo-pesquisa').val();
                    if (dataPesquisa) {
                        ajaxApi('search', {param: dataPesquisa}, callbackSearch);
                    }
                });

                // callback da pesquisa
                var callbackSearch = function(a) {
                    templateSearch.compileAndLoadData(a);
                };

            });


            // -----------------------------------------------------------------
            // filtro
            securePage('filter', function (page) {
                var templateFilter = new Template('templateFilter');

                // busca categorias
                ajaxApi('filter-category', {}, function(a) {
                    templateFilter.compileAndLoadData(a);
                    
                    // slides
                    myApp.swiper('.swiper-4', {
                      //pagination:'.swiper-4 .swiper-pagination',
                      spaceBetween: 20,
                      slidesPerView: 4
                    });
                });

            });


            // -----------------------------------------------------------------
            // convidar amigo
            securePage('invite-friend', function (page) {
                var templateInviteFriend = new Template('templateInviteFriend');
                templateInviteFriend.compileAjax('invite-friend', {user_auth_key: getUserData().auth_key});
            });


            // -----------------------------------------------------------------
            // solicitar saque
            securePage('cash-out', function (page) {
                var templateCashOut = new Template('templateCashOut');
                var callbackCashOut = function (a) {
                    
                    // form de solicitacao de saque
                    var formCashOut = new Form('cashOut-form');
                    
                    // add opcoes de banco
                    formCashOut.addOptionsSelect("CB03_COD_BANCO", a.bancos);
                    
                    // add opcoes de tipo de conta
                    formCashOut.addOptionsSelect("CB03_TP_CONTA", a.tp_conta);
                    
                    // add mascara de moeda (REAL)
                    formCashOut.setMoney(["CB03_VALOR"]);
                    
                    // set attributes
                    if (typeof a.conta_bancaria != "undefined") {
                        formCashOut.setFormData(a.conta_bancaria);
                    }
                    
                    $('a#cashOut-submit').on('click', function () {
                        ajaxCashOut(formCashOut.getFormData());
                    });
                };

                // busca dados da tela de solicitacao de saque
                ajaxCashOut = function (param) { 
                    var param = (param || {});
                    templateCashOut.compileAjax('cash-out', $.extend(param, {user_auth_key: getUserData().auth_key}), callbackCashOut);
                };
                
                ajaxCashOut();
                
            });


            // -----------------------------------------------------------------
            // minhas compras
            securePage('shopping', function (page) {
                var templateShopping = new Template('templateShopping');
                templateShopping.compileAjax('shopping', {user_auth_key: getUserData().auth_key});
            });


            // -----------------------------------------------------------------
            // estabelecimento
            securePage('establishment', function (page) {
                var templateEstablishment = new Template('templateEstablishment');
                templateEstablishment.compileAjax('establishment', {});
            });


            // -----------------------------------------------------------------
            // mensagem de compra realizada
            securePage('purchase-message', function (page) {
                var templatePurchaseMessage = new Template('templatePurchaseMessage');
                templatePurchaseMessage.compileAjax('purchase-message', {});
            });


            // -----------------------------------------------------------------
            // perfil
            securePage('profile', function (page) {
                var templateProfile = new Template('templateProfile');
                templateProfile.compileAjax('profile', {user_auth_key: getUserData().auth_key});
            });


            // -----------------------------------------------------------------
            // alterar senha
            securePage('change-password', function (page) {
                var templateProfile = new Template('templateChangePassword');
                templateProfile.compileAndLoadData();

                // form - alterar senha
                var formChangePassword = new Form('changePassword-form');
                
                // salvar
                $('a#changePassword-submit').on('click', function () {
                    var param = formChangePassword.getFormData();
                    if(param['current-password'] === '' || param['new-password'] === '') {
                        myApp.alert('','Preencha os dois campos.');
                        return;
                    }
                    ajaxApiUser('change-password', param, function(a){
                        if(typeof a.message != 'undefined') {
                            formChangePassword.clear();
                            myApp.alert('',a.message);
                        }
                    });
                });
                
            });

            // -----------------------------------------------------------------
            // checkout
            securePage('checkout', function (page) {
                var templateProfile = new Template('templateCheckout'),
                pageQuery = page.query,
                param = pageQuery;
                param.user_auth_key = getUserData().auth_key;
                templateProfile.compileAjax('checkout', param, function (a) {
                    if(a === false) {
                        mainView.router.loadPage('main.html'); 
                        
                    } else {
                        // form - checkout
                        var formCheckout = new Form('checkout-form');

                        // iugu
                        ajaxApiUser('iugu-id-account', {}, function(a){
                            if(a){
                                Iugu.setAccountID(a); // id Iugu
                                Iugu.setTestMode(true); // para teste
                                Iugu.setup(); // validar os dados de cartao no form
                            }
                        });

                        // salvar
                        $('a#checkout-submit').on('click', function () {

                            // cria token do pagamento
                            Iugu.createPaymentToken(formCheckout.form[0], function(data) {
                                if (data.errors) {
                                    myApp.alert(Util.errorCartToString(data.errors), 'Opss');

                                } else {
                                    $("#token").val( data.id );
                                    paramPurchase = pageQuery;
                                    paramPurchase.data = formCheckout.getFormData();
                                    ajaxApiUser('checkout-purchase', paramPurchase, function(a){
                                        if (a.status === true) {
                                            myApp.alert('Pagamento efetuado!', 'Tudo Certo');
                                            mainView.router.loadPage('purchase-message.html');
                                        } else {
                                            myApp.alert('Não foi possível efetuar o pagamento, tente novamente.', 'Opss');
                                            
                                        }
                                    });
                                }
                            });
                            return;
                            
                        }); 
                        
                    }
                });
                
            });


            // -----------------------------------------------------------------
            // produtos do estabelecimento
            securePage('company', function (page) {
                var templateProfile = new Template('templateCompany'),
                paramDefault = {company: '', product: ''},
                paramNew = page.query,
                companyAtual = paramNew.company;
                
                $.extend(paramDefault, paramNew);
                
                templateProfile.compileAjax('company', paramDefault, function (a) {
                    if(a === false || !a.produtos.length) {
                        mainView.router.loadPage('main.html'); 
                        
                    } else {
                        var a, idProdutoAtual = false, promocaoAtual = false;
                        
                        // Template do produto (fotos, abas e btn "comprar")
                        a.loadTemplateProduto = function (id) {
                            idProdutoAtual = id;
                            var templateProduct = new Template('templateProduct', idProdutoAtual);
                          
                            
                            templateProduct.compileAjax('company-product', {product: idProdutoAtual}, function(r_product){
                                
                                // slider image
                                myApp.swiper('.swiper-image-product', {
                                    pagination:'.swiper-image-product .swiper-pagination',
                                    paginationHide: false,
                                    paginationClickable: true,
                                    spaceBetween: 50, // between slides
                                    preloadImages: false,
                                    lazyLoading: true,
                                    //nextButton: '.swiper-button-next',
                                    //prevButton: '.swiper-button-prev',
                                });
                                
                                // carrega abas do produto
                                a.loadTemplatePromocoes();
                                a.loadTemplateRegras();
                                a.loadTemplateLocal();
                                
                            });
                            
                        };
                        
                        // Template com as promocoes do produto (list)
                        a.loadTemplatePromocoes = function () {
                            var templatePromotions = new Template('templatePromotions', idProdutoAtual);
                            templatePromotions.compileAjax('company-promotions', {product: idProdutoAtual}, function(r_promotions){
                                
                                // cria evento de click nas promocoes
                                $$('.promocoes-do-produto').on('click', function (){
                                    var dataPromocao = $(this).attr('user-data');
                                    if (dataPromocao) {
                                        a.loadValueTabbarBuy(JSON.parse(dataPromocao));
                                    }
                                });
                                
                                // verifica se alguma promocao foi marcada para atualizar os valores de compra
                                promocaoSelecionada = $('input[name="promocoes-checkbox"]:checked');
                                if(promocaoSelecionada){
                                    promocaoSelecionada.trigger( "click" );
                                }
                            });
                        };
                        
                        // Template com as regras do produto (Text)
                        a.loadTemplateRegras = function () {
                            var templateRules = new Template('templateRules', idProdutoAtual);
                            templateRules.compileAjax('company-rules', {product: idProdutoAtual});
                        };
                        
                        // Template com informacoes sobre o local (Text)
                        a.loadTemplateLocal = function () {
                            var templateLocal = new Template('templateLocal', idProdutoAtual);
                            templateLocal.compileAjax('company-local', {company: companyAtual});
                        };
                        
                        // carrega valores na tab bar Comprar
                        a.loadValueTabbarBuy = function (data) {
                            promocaoAtual = data;
                            $('#tabbar-buy #tabbar-buy-pague').text('R$ ' + data.valor);
                            $('#tabbar-buy #tabbar-buy-de-volta').text(data.deVolta + '%');
                        };
                        
                        // cria os evento de click nas abas dos produtos
                        $$('.show-tab').on('click', function () {
                            a.loadTemplateProduto($(this).attr('data-product'));
                        });
                        
                        // cria os evento de click no botao comprar
                        $$('#tabbar-buy #buy-submit').on('click', function () {
                            // se alguma promocao estiver marcada realiza o pedido
                            if (typeof promocaoAtual === 'object') {
                                ajaxApiUser('company-buy-product', promocaoAtual, function (a) {
                                    if(a) {
                                        mainView.router.loadPage('checkout.html?order=' + a);
                                    }
                                });
                            } else {
                                myApp.alert('', 'Selecione uma promoção');
                            }
                        });
                        
                        // carrega o produto da "aba ativa"
                        a.loadTemplateProduto(a.produtoAtual.CB05_ID);
                        
                    }
                });
                
            });

            
        </script>

    </body>
</html>


